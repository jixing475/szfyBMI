---
title: "BMI data clean and EDA"
description: |
  this note is for BMI data!
author:
  - name: Jixing Liu
    url: https://jixing.netlify.com/
    affiliation: æ·±åœ³å¦‡å¹¼
date: "`r Sys.Date()`"
#bibliography: biblio.bib  
output:
  radix::radix_article:
    toc: true
    toc_depth: 3
    number_sections: true
    self_contained: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
    echo = TRUE,      # Output code chunks
    message = FALSE,  # Toggle off message output 
    warning = FALSE,    # Toggle off warning output
    fig.width = 6, fig.asp = 0.618, out.width = "70%", fig.align = "center") 

knitr::opts_knit$set(root.dir = usethis::proj_path())
library(docknitr)

# libraries used in report
library(knitr)
library(kableExtra)
library(tidyverse)

theme_set(theme_light(base_family = "Avenir"))
```
## function

```{r}
na_x2na <- function (s, x = 0)
{
    sapply(s, function(y)
        ifelse(y %in% x, NA, y))
}

time_calc <-
  function(string) {
    time_w_d <- string %>%
      str_split("\\+") %>% unlist()  %>%
      as.numeric()
    time = time_w_d[1] * 7 + time_w_d[2]
    return(time)
  }
```


## Import Data
```{r}
library(readxl)
raw_data <- read_excel("analysis/data/raw_data/BMI_2020-07-23.xlsx")

```


```{r}
meta_data <- data.frame(
  stringsAsFactors = FALSE,
              note = c("ç—…æ¡ˆå·","æœ«æ¬¡æœˆç»","å§“å","ç±è´¯","æ°‘æ—",
                       "æ–‡åŒ–ç¨‹åº¦","ä¸»è¦è¯Šæ–­","å…¶ä»–è¯Šæ–­",
                       "HDP(0:è¡€å‹æ­£å¸¸ï¼Œ1GHï¼Œ2PEï¼Œ3é‡PEï¼Œ4å­ç—«ï¼Œ5æ…¢é«˜ï¼Œ6æ…¢é«˜å¹¶PEï¼Œ7é•œåƒ)","GDM","FGR(1FGR","æ’é™¤è¯Šæ–­","ä½é™¢æ€»è´¹ç”¨",
                       "ä½é™¢å¤©æ•°","åˆ†å¨©å­•å‘¨","ç±»å‹ï¼ˆ1æ—©å‘ï¼Œ2æ™šå‘â‰¥34å‘¨ï¼‰","åˆ†å¨©æ–¹å¼","å©´å„¿æ€§åˆ«","å©´å„¿åˆ†å¨©ç»“æœ",
                       "å©´å„¿ä½“é‡","SGA/LGAï¼ˆæ­£å¸¸0SGA1LGA2ï¼‰","å…¥ä½MICU",
                       "å…¥ä½NICUï¼ˆ0å‡ºé™¢ï¼Œ1è½¬ç§‘ï¼‰","å©´å„¿è½¬å½’","å©´å„¿æŠ¢æ•‘æ¬¡æ•°","1åˆ†é’ŸAPgarè¯„åˆ†","5åˆ†é’ŸApgarè¯„åˆ†","ä¸ˆå¤«æ–‡åŒ–ç¨‹åº¦",
                       "ä¸ˆå¤«èº«é«˜","ä¸ˆå¤«ä½“é‡","å­•å‰èº«é«˜ï¼ˆm)","å­•å‰ä½“é‡","å­•å‰BMI",
                       "WHOè‚¥èƒ–ï¼ˆ0:ï¼œ18.4,1:18.5-24.9,2:25-29.9,3:â‰¥30ï¼‰",
                       "ä¸­å›½è‚¥èƒ–æ ‡å‡†ï¼ˆ0ï¼œ18.4ï¼Œ1ï¼š18.5-23.9ï¼Œ2ï¼š24-27.9ï¼Œ3ï¼š28-31.9,4:32-36.9,5:â‰¥37ï¼‰","ALT","AST",
                       "ALBï¼ˆç™½è›‹ç™½ï¼‰","TBAï¼ˆæ€»èƒ†æ±é…¸ï¼‰","LDH","Cr","å°¿ç´ ","Uricå°¿é…¸",
                       "APTT","PT","INR","ATIII","DD","çº¤ç»´è›‹ç™½åŸ","PLT"),
               col = c("ID","last menstrual period",
                       "name","native place","nation","Level of education",
                       "principal diagnosis","Other diagnostic","HDP","GDM",
                       "FGR","Exclude diagnosis","the in-patients costs",
                       "Hospitalization days","Delivery gestational age","type",
                       "Delivery way","A baby's sex","Baby delivery results",
                       "The baby weight","SGA_LGA","Check-in MICU",
                       "Check-in NICU","Infant outcome","Baby salvage number",
                       "1 minute APgar score","5 minute APgar score",
                       "Husband culture degree","Husband's height","Husband's weight",
                       "Pregnancy height","Pregnancy weight","Pregnancy BMI",
                       "WHO obesity","china obesity","ALT","AST","ALB","TBA","LDH",
                       "Cr","BUN","Uric acid","APTT","PT","INR","ATIII",
                       "DD","fibrinogen","PLT")
)

```


```{r}
colnames(raw_data) <- meta_data$col
raw_data <- 
  raw_data %>% janitor::clean_names()
meta_data$col <- colnames(raw_data)

```

## ğŸ“Œ  select data

```{r}
select_cols <- 
  c("id",
  "pregnancy_bmi",
  "pregnancy_height",
  "pregnancy_weight",
  "principal_diagnosis",
  "other_diagnostic",
  "delivery_gestational_age",
  "type",
  "delivery_way",
  "the_baby_weight",
  "check_in_nicu",
  "x1_minute_a_pgar_score",
  "x5_minute_a_pgar_score",
  "fgr",
  "alt",
  "ast",
  "alb",
  "tba",
  "ldh",
  "cr",
  "bun",
  "uric_acid",
  "aptt",
  "pt",
  "inr",
  "atiii",
  "dd",
  "fibrinogen",
  "plt")


data <- 
  raw_data %>% 
  select(select_cols)

```



## ğŸ“Œ  Tidy Data


### è½¬æ¢å˜é‡
```{r}
data_tidy <- 
  data %>%
  # é‡æ–°è®¡ç®— BMI ==============================
  # æŠŠæ ‡é”™å•ä½çš„ cm è½¬æˆ m
  mutate(pregnancy_height = if_else(
    pregnancy_height >= 100,
    pregnancy_height / 100,
    pregnancy_height
  )) %>% 
  mutate(BMI = 
         cchsflow::bmi_fun(pregnancy_height, pregnancy_weight)) %>%
  select(-pregnancy_bmi, -pregnancy_height, -pregnancy_weight) %>%
  # PE è¡¨å‹ ==============================
  mutate(total_diagnosis = str_c(principal_diagnosis, ", ", other_diagnostic)) %>% 
  # æå–é‡åº¦è½»åº¦å­—æ ·
  mutate(
  PE_LH_type = 
    total_diagnosis %>%
    str_extract("é‡åº¦|è½»åº¦") 
  ) %>% 
  # NA + å…ˆå…†å­ç—«|å­ç—«å‰æœŸ = è½»åº¦ 
  mutate(
    PE_LH_type = 
           if_else(is.na(PE_LH_type) & str_detect(total_diagnosis, "å…ˆå…†å­ç—«|å­ç—«å‰æœŸ"),
                   "è½»åº¦",
                   PE_LH_type)
  ) %>% 
  # NA + é»‘å°”æ™®ç»¼åˆå¾|èƒå„¿ç”Ÿé•¿å‘è‚²è¿Ÿç¼“ = é‡åº¦ 
  mutate(
    PE_LH_type = 
           if_else(is.na(PE_LH_type) & str_detect(total_diagnosis, "é»‘å°”æ™®ç»¼åˆå¾|èƒå„¿ç”Ÿé•¿å‘è‚²è¿Ÿç¼“"),
                   "é‡åº¦",
                   PE_LH_type)
    ) %>% 
  select(-principal_diagnosis, -other_diagnostic, -total_diagnosis) %>% 
  # è½¬æ¢å­•å‘¨ä¸ºå¤© ==============================
  mutate(delivery_gestational_age = 
           if_else(str_detect(delivery_gestational_age, "\\+"), 
                   time_calc(delivery_gestational_age),
                   as.numeric(delivery_gestational_age) * 7)
         ) %>% 
  # æ›¿ä»£å®éªŒæ£€æŸ¥ä¸­çš„ 0 ä¸º ç¼ºå¤±å€¼ ==============================
  mutate_at(
    c(
      "alt",
      "ast",
      "alb",
      "tba",
      "ldh",
      "cr",
      "bun",
      "uric_acid",
      "aptt",
      "pt",
      "inr",
      "atiii",
      "dd",
      "fibrinogen",
      "plt"
    ),
    ~ na_x2na(., x = 0)
  ) %>% 
  # å˜é‡ç±»å‹ ==============================
  mutate(PE_LH_type = as_factor(PE_LH_type)) %>% 
  mutate(check_in_nicu = if_else(check_in_nicu == 0, "å‡ºé™¢", "è½¬ç§‘") %>% as.factor()) %>% 
  mutate(type = as_factor(type))  %>% 
  mutate(delivery_way = as_factor(delivery_way)) %>% 
  mutate(fgr = as_factor(fgr)) %>% 
  mutate(the_baby_weight = as.numeric(the_baby_weight)/1000) 
  
```


## Y çš„æ­£æ€åˆ†å¸ƒ


## EDA

```{r}
#Explore Your Dataset
library(tidyverse)
df <- data_tidy
#==== HEAD ====
#==== DIM AND GLIMPSE ====
dim(df)
glimpse(df)

library(skimr)
skim(df)

library(visdat)
vis_miss(df)
vis_dat(df)

#==== CREATE_REPORT IN DATAEXPLORER ====
library(DataExplorer)
DataExplorer::create_report(df)
```


## Transform

## ä¸€èˆ¬çº¿æ€§æ¨¡å‹çš„å‡è®¾

1. æ­£æ€æ€§: Y å˜é‡è¦æ˜¯æ­£æ€åˆ†å¸ƒ âœ…   
2. ç‹¬ç«‹æ€§: æ ·æœ¬é—´ç‹¬ç«‹, æ²¡æœ‰é‡å¤
3. çº¿æ€§: Y ä¸ X ä¹‹é—´æ˜¯çº¿æ€§çš„
4. åŒæ–¹å·®æ€§: å› å˜é‡çš„æ–¹å·®ä¸éšè‡ªå˜é‡çš„æ°´å¹³ä¸åŒè€Œå˜åŒ– âœ…   


## å¤šå…ƒå›å½’çš„ç¬¬ä¸€æ­¥æœ€å¥½æ£€æŸ¥ä¸€ä¸‹å˜é‡é—´çš„ç›¸å…³æ€§

```{r}
require(data.table)
require(ggplot2)
require(GGally)

data_tidy %>%
  select(BMI, PE_LH_type, type) %>%
  ggpairs(columns = 1:2, mapping = aes(colour = type))

```


## ğŸ“Œ  æƒ³å›ç­”çš„é—®é¢˜

åŸºæœ¬å»ºæ¨¡å½¢å¼: Y ~ BMI + Age + åˆäº§

###  PE è¡¨å‹

1. æ—©å‘å‹PEã€æ™šå‘å‹PE
2. è½»åº¦PEã€é‡åº¦PE
3. æ—©å‘é‡åº¦ã€æ™šå‘é‡åº¦

#### 1. æ—©å‘å‹PEã€æ™šå‘å‹PE
```{r}
data_tidy %>%
  glm(type ~ BMI, data = ., family = binomial) %>% 
  broom::tidy() %>% 
  .[2, ] 
```

#### 2. è½»åº¦PEã€é‡åº¦PE

```{r}
data_tidy %>%
  glm(PE_LH_type ~ BMI, data = ., family = binomial) %>% 
  broom::tidy() %>% 
  .[2, ] 
```


#### 3.æ—©å‘é‡åº¦ã€æ™šå‘é‡åº¦
```{r}
data_tidy %>%
  filter(PE_LH_type == "é‡åº¦") %>% 
  glm(type ~ BMI, data = ., family = binomial) %>% 
  broom::tidy() %>% 
  .[2, ] 
```


### å¦Šå¨ ç»“å±€

1. å­•å‘¨
2. åˆ†å¨©æ–¹å¼
3. å‡ºç”Ÿä½“é‡
4. å°äºèƒé¾„å„¿
5. å…¥ä½ NICU
6. Apgar

```{r}
data_BMI_pregnancy <-
  data_tidy %>%
  mutate(BMI_group = if_else(BMI >= 30, "obesity", "no_obesity") %>% as.factor()) %>%
  select(
    c(
      "delivery_gestational_age",
      "delivery_way",
      "the_baby_weight",
      "check_in_nicu",
      "x1_minute_a_pgar_score",
      "x5_minute_a_pgar_score",
      "BMI_group"
    )
  )
data_BMI_pregnancy %>%
  write_csv("analysis/data/derived_data/å¦Šå¨ ç»“å±€_BMI.csv")
```

```{r}

ggpairs(
  data_BMI_pregnancy %>% filter(!is.na(BMI_group)),
  columns = 1:(ncol(data_BMI_pregnancy) - 1),
  mapping = aes(colour = BMI_group)
)

```

```{r}
library(tidyverse)
theme_set(theme_light())
# with fill ==============================
data_BMI_pregnancy %>%
  filter(!is.na(BMI_group)) %>% 
  {bind_cols(select_if(., is.numeric),
             select_at(., "BMI_group"))
  } %>%
  gather(-BMI_group, key = "var", value = "value") %>%
  ggplot(aes(x = value, fill = BMI_group)) + 
  geom_density() +
  facet_wrap(~ var, scales = "free") 
```


### åœ¨é‡åº¦ PE ä¸­, å™¨å®˜åŠŸèƒ½æŸä¼¤

1. è‚åŠŸèƒ½æŸä¼¤
2. è‚¾åŠŸèƒ½æŸä¼¤
3. PLT å‡å°‘
4. HLD å‡é«˜
5. ä½è›‹ç™½è¡€ç—‡

```{r}
data_tidy %>% 
  filter(PE_LH_type == "é‡åº¦") %>% 
  mutate(BMI_group = if_else(BMI>= 30, "obesity", "no_obesity") %>% as.factor()) %>% 
  select(c("fgr","alt","ast","alb","tba","ldh","cr","bun","uric_acid","aptt","pt","inr","atiii","dd","fibrinogen","plt", "BMI_group")) %>% 
  write_csv("analysis/data/derived_data/é‡åº¦ PE_å™¨å®˜åŠŸèƒ½_BMI.csv")
```


## æ•°æ®é—®é¢˜

1. ä¸¤å¼ è¡¨æ ¼ç”¨åˆå¹¶è¡¨æ ¼, é‡åº¦ PE æ˜¯æ˜¯åˆå¹¶è¡¨æ ¼çš„å­é›† âœ…   
2. __age__ å’Œ __æ˜¯å¦æ˜¯åˆäº§å¦‡__çš„å˜é‡æ²¡æœ‰
3. BMI è¦é‡æ–°è®¡ç®—, æœ‰äº›å•ä½æé”™äº†, å•ä½æ˜¯ M, å¼„æˆ cm âœ…   
4. FGA == FGR âœ…   
5. PE è¡¨å‹è¦ç”¨æ­£åˆ™è¡¨è¾¾å¼è¿›è¡Œæå– âœ…   

## å‡ ä¸ªå°é—®é¢˜

1. å©´å„¿æŠ¢æ•‘æ¬¡æ•°: null ä¸ 0 æ˜¯ä¸€æ ·å—? __æ˜¯çš„__
2. ç©ºç™½æ˜¯ç¼ºå¤±æ•°æ®å—? __æ˜¯çš„__
3. å©´å„¿è½¬å½’ä¸­çš„ / æ˜¯ä»€ä¹ˆæ„æ€? __ç¼ºå¤±æ•°æ®__
4. å­•å‰èº«é«˜ä¸­çš„: 0 å’Œå°æ•° æ˜¯ä»€ä¹ˆæ„æ€? __0 æ˜¯ç¼ºå¤±, å°æ•°æ˜¯å•ä½é”™è¯¯, m å†™æˆ cm __
5. å­•å‰BMI ä¸­çš„ 0 ä¸ 0.00? æ˜¯ä»€ä¹ˆæ„æ€ __æ•°æ®ç¼ºå¤±, å•ä½é”™è¯¯__
6. è‚¥èƒ–ä¸­çš„ / æ˜¯ä»€ä¹ˆæ„æ€ __ç¼ºå¤±__
7. å®éªŒå®¤æ£€æŸ¥å˜é‡ä¸­çš„ 0 æ˜¯ä»€ä¹ˆæ„æ€? __ç¼ºå¤±__




